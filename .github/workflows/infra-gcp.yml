# .github/workflows/infra-gcp.yml
name: Infra GCP

on:
  workflow_dispatch:            # executa manualmente no UI

env:
  PROJECT_ID: app-chamada-stage
  REGION:     us-west1
  ZONE:       us-west1-a
  BUCKET:     iac-stage-tfstate          # bucket remoto do state
  CLUSTER:    app-chamada-stage          # nome exato do cluster
  NODEPOOL:   primary                    # nome do node-pool
  REPO_NAME:  frontend                   # Artifact Registry repo

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
    # 0Ô∏è‚É£  Checkout
    - name: Checkout repo
      uses: actions/checkout@v4

    # 1Ô∏è‚É£  Auth no GCP (exp√µe GOOGLE_APPLICATION_CREDENTIALS)
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

    # 2Ô∏è‚É£  gcloud + kubectl + gsutil
    - name: Setup gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    # 3Ô∏è‚É£  Cria o bucket do state (idempotente)
    - name: Create state bucket (idempotent)
      run: |
        if gsutil ls -b "gs://${BUCKET}" >/dev/null 2>&1; then
          echo "‚úÖ  Bucket gs://${BUCKET} j√° existe"
        else
          echo "ü™£  Criando bucket gs://${BUCKET}‚Ä¶"
          gsutil mb -l $REGION "gs://${BUCKET}"
          # opcional: vers√£o de objetos
          gsutil versioning set on "gs://${BUCKET}"
        fi

    # 4Ô∏è‚É£  Instala Terraform
    - uses: hashicorp/setup-terraform@v3

    # 5Ô∏è‚É£  Terraform init ‚Äì agora com backend remoto
    - name: Terraform Init
      working-directory: gcp
      run: |
        terraform init -input=false \
          -backend-config="bucket=${BUCKET}" \
          -backend-config="prefix=terraform" \
          -upgrade

    # 6Ô∏è‚É£  Terraform Validate / Plan
    - name: Terraform Validate
      working-directory: gcp
      run: terraform validate -no-color

    - name: Terraform Plan
      working-directory: gcp
      env:
        TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
      run: terraform plan -no-color

    # 5Ô∏è‚É£  Importa o Artifact Registry se ele J√Å existir
    - name: Import existing Artifact Registry (if any)
      working-directory: gcp
      env:
        PROJECT_ID: ${{ env.PROJECT_ID }}
        REGION:     ${{ env.REGION }}
        TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}  # ‚Üê aqui!
      run: |
        set -e
        echo "üîç  Verificando se recurso j√° est√° no state‚Ä¶"
        if terraform state list 2>/dev/null | grep -q \
            '^google_artifact_registry_repository.frontend$'; then
          echo "‚úÖ  J√° est√° no state ‚Äì pulando import."
          exit 0
        fi

        echo "üîç  Verificando se o reposit√≥rio existe no projeto GCP‚Ä¶"
        if gcloud artifacts repositories describe frontend \
              --location="${REGION}" \
              --project="${PROJECT_ID}" \
              --quiet >/dev/null 2>&1; then
          echo "üì¶  Repo encontrado ‚Äì importando para o state."
          terraform import -input=false -no-color \
            google_artifact_registry_repository.frontend \
            "projects/${PROJECT_ID}/locations/${REGION}/repositories/frontend"
        else
          echo "‚ÑπÔ∏è  Repo ainda n√£o existe ‚Äì ser√° criado no terraform apply."
        fi

    # 8Ô∏è‚É£  IMPORTA Cluster e NodePool, se j√° existirem
    # ‚¨áÔ∏è  Importa o cluster se ele j√° existir
    - name: Import existing GKE cluster (if any)
      working-directory: gcp
      env:
        PROJECT_ID: ${{ env.PROJECT_ID }}
        ZONE:       ${{ env.ZONE }}
        TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}   # ‚Üê aqui!
      run: |
        set -e
        echo "üîç  Verificando se o cluster j√° est√° no state‚Ä¶"
        if terraform state list 2>/dev/null | grep -q \
            '^google_container_cluster.frontend$'; then
          echo "‚úÖ  J√° est√° no state ‚Äì pulando import."
          exit 0
        fi

        echo "üîç  Verificando se o cluster existe no projeto‚Ä¶"
        if gcloud container clusters describe app-chamada-stage \
              --zone "${ZONE}" \
              --project "${PROJECT_ID}" \
              --quiet >/dev/null 2>&1; then
          echo "üì¶  Cluster encontrado ‚Äì importando para o state."
          terraform import -input=false -no-color \
            google_container_cluster.frontend \
            "projects/${PROJECT_ID}/locations/${ZONE}/clusters/app-chamada-stage"
        else
          echo "‚ÑπÔ∏è  Cluster ainda n√£o existe ‚Äì ser√° criado no terraform apply."
        fi

    # 9Ô∏è‚É£  Apply
    - name: Terraform Apply
      working-directory: gcp
      env:
        TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
      run: terraform apply -auto-approve -no-color
