name: Infra GCP

on:
  workflow_dispatch:            # dispara manualmente pelo GitHub UI

env:
  PROJECT_ID: app-chamada-stage           # â¬…ï¸  ajuste se mudar o projeto
  REGION:     us-west1                    # â¬…ï¸  mesma regiÃ£o do cluster / repo
  ZONE:       us-west1-a                  # â¬…ï¸  zona do cluster

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # 0ï¸âƒ£  Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1ï¸âƒ£  AutenticaÃ§Ã£o GCP (exporta GOOGLE_APPLICATION_CREDENTIALS)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # 2ï¸âƒ£  Instala gcloud + kubectl
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 3ï¸âƒ£  Instala Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 4ï¸âƒ£  Init / Validate / Plan
      - name: Terraform Init
        working-directory: gcp
        run: terraform init -upgrade -input=false

      - name: Terraform Validate
        working-directory: gcp
        run: terraform validate

      - name: Terraform Plan
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform plan

      # 5ï¸âƒ£  Importa o Artifact Registry se ele JÃ existir
      - name: Import existing Artifact Registry (first run only)
        working-directory: gcp
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION:     ${{ env.REGION }}
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}   # ğŸ‘ˆ  DISPONÃVEL PARA O IMPORT
        run: |
          set -e

          echo "ğŸ” Verificando se terraform.tfstate jÃ¡ existeâ€¦"
          if [ ! -f terraform.tfstate ]; then
            echo "â„¹ï¸  Nenhum state local â€“ import possÃ­vel."
          fi

          echo "ğŸ” Verificando se o repositÃ³rio 'frontend' existe no projetoâ€¦"
          if gcloud artifacts repositories describe frontend \
                --location=${REGION} \
                --project=${PROJECT_ID} \
                --quiet >/dev/null 2>&1; then
            echo "ğŸ“¦  Repo encontrado â€“ importando para o state."
            terraform import \
              -input=false \                      # ğŸš« sem prompt
              -lock-timeout=0s \                  # opcional
              google_artifact_registry_repository.frontend \
              projects/${PROJECT_ID}/locations/${REGION}/repositories/frontend
          else
            echo "âœ…  Repo ainda nÃ£o existe â€“ serÃ¡ criado no apply."
          fi


      # 6ï¸âƒ£  Apply
      - name: Terraform Apply
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform apply -auto-approve
