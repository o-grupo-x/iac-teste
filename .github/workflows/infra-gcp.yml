name: Infra GCP

on:
  workflow_dispatch:            # dispara manualmente pelo GitHub UI

env:
  PROJECT_ID: app-chamada-stage           # ‚¨ÖÔ∏è  ajuste se mudar o projeto
  REGION:     us-west1                    # ‚¨ÖÔ∏è  mesma regi√£o do cluster / repo
  ZONE:       us-west1-a                  # ‚¨ÖÔ∏è  zona do cluster

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # 0Ô∏è‚É£  Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1Ô∏è‚É£  Autentica√ß√£o GCP (exporta GOOGLE_APPLICATION_CREDENTIALS)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # 2Ô∏è‚É£  Instala gcloud + kubectl
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 3Ô∏è‚É£  Instala Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 4Ô∏è‚É£  Init / Validate / Plan
      - name: Terraform Init
        working-directory: gcp
        run: terraform init -upgrade -input=false

      - name: Terraform Validate
        working-directory: gcp
        run: terraform validate

      - name: Terraform Plan
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform plan

      # 5Ô∏è‚É£ Importa o Artifact Registry apenas se ainda n√£o estiver no state
      - name: Import existing Artifact Registry (first run only)
        working-directory: gcp
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION:     ${{ env.REGION }}
        run: |
          set -e
          echo "üîç Verificando se o recurso j√° est√° no state‚Ä¶"
          if terraform state list \
               | grep -q '^google_artifact_registry_repository.frontend$'; then
            echo "‚úÖ J√° est√° no state ‚Äì passo ignorado."
            exit 0
          fi

          echo "üîç Verificando se o reposit√≥rio existe no projeto‚Ä¶"
          if gcloud artifacts repositories describe frontend \
                --location=${REGION} \
                --project=${PROJECT_ID} \
                --quiet >/dev/null 2>&1; then
            echo "üì¶ Repo existe ‚Äì importando para o state."
            terraform import -no-color \
              google_artifact_registry_repository.frontend \
              projects/${PROJECT_ID}/locations/${REGION}/repositories/frontend
          else
            echo "‚ÑπÔ∏è  Repo ainda n√£o existe ‚Äì ser√° criado no apply."
          fi

      # 6Ô∏è‚É£  Apply
      - name: Terraform Apply
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform apply -auto-approve
