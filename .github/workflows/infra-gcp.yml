name: Infra GCP

on:
  workflow_dispatch:            # dispara manualmente pelo GitHub UI

env:
  PROJECT_ID: app-chamada-stage           # ⬅️  ajuste se mudar o projeto
  REGION:     us-west1                    # ⬅️  mesma região do cluster / repo
  ZONE:       us-west1-a                  # ⬅️  zona do cluster

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # 0️⃣  Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1️⃣  Autenticação GCP (exporta GOOGLE_APPLICATION_CREDENTIALS)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # 2️⃣  Instala gcloud + kubectl
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 3️⃣  Instala Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 4️⃣  Init / Validate / Plan
      - name: Terraform Init
        working-directory: gcp
        run: terraform init -upgrade -input=false

      - name: Terraform Validate
        working-directory: gcp
        run: terraform validate

      - name: Terraform Plan
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform plan

      # 5️⃣  Importa o Artifact Registry se ele JÁ existir
      - name: Import existing Artifact Registry (first run only)
        working-directory: gcp
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION:     ${{ env.REGION }}
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}   # 👈  DISPONÍVEL PARA O IMPORT
        run: |
          set -e

          echo "🔍 Verificando se terraform.tfstate já existe…"
          if [ ! -f terraform.tfstate ]; then
            echo "ℹ️  Nenhum state local – import possível."
          fi

          echo "🔍 Verificando se o repositório 'frontend' existe no projeto…"
          if gcloud artifacts repositories describe frontend \
                --location=${REGION} \
                --project=${PROJECT_ID} \
                --quiet >/dev/null 2>&1; then
            echo "📦  Repo encontrado – importando para o state."
            terraform import \
              -input=false \                      # 🚫 sem prompt
              -lock-timeout=0s \                  # opcional
              google_artifact_registry_repository.frontend \
              projects/${PROJECT_ID}/locations/${REGION}/repositories/frontend
          else
            echo "✅  Repo ainda não existe – será criado no apply."
          fi


      # 6️⃣  Apply
      - name: Terraform Apply
        working-directory: gcp
        env:
          TF_VAR_gcp_credentials: ${{ secrets.GCP_CREDENTIALS_JSON }}
        run: terraform apply -auto-approve
